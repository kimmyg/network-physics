<!DOCTYPE html>
<html>

<head>
<script type="text/javascript">
function $( id ) {
	return document.getElementById( id );
}

canvas = null;
context = null;

simulation = null;

function NetForce() {
	this.forces = [];

	this.x = 0;
	this.y = 0;
}

NetForce.prototype.set = function( key, fx, fy ) {
	var i = 0;

	while( i < this.forces.length && this.forces[i] !== key ) {
		i += 3;
	}

	if( i < this.forces.length ) {
		this.x -= this.forces[i+1];
		this.y -= this.forces[i+2];

		this.forces[i+1] = fx;
		this.forces[i+2] = fy;
	}
	else {
		this.forces.push( key );
		this.forces.push( fx );
		this.forces.push( fy );
	}

	this.x += fx;
	this.y += fy;
}

NetForce.prototype.delete = function( key ) {
	var i = 0;

	while( i < this.forces.length && this.forces[i] !== key ) {
		i += 3;
	}

	if( i < this.forces.length ) {
		this.x -= this.forces[i+1];
		this.y -= this.forces[i+2];

		this.forces.splice( i, 3 );
	}
}

function Simulation() {
	this.objects = [];
	this.events = [];
	this.keys = {};

	var self = this;

	this.pushEvent = function( event ) {
		if( event.keyCode === 39 || true ) { // should do generic event filter
			self.events.push( event );
		}
	};
}

Simulation.prototype.add = function( x, y, a, vx, vy, va, ax, ay, aa ) {
	this.objects.push([ x, y, a, vx, vy, va, new NetForce(), aa ]);
}

Simulation.prototype.pass = function( t ) {
	var dt = ( t - this.t0 ) / 1000;

	for( var i = 0; i < this.objects.length; ++i ) {
		var o = this.objects[i];

		o[0] += o[3] * dt + o[6].x * dt * dt;
		o[1] += o[4] * dt + o[6].y * dt * dt;
		o[2] += o[5] * dt + o[7] * dt * dt;

		o[3] += o[6].x * dt;
		o[4] += o[6].y * dt;
		o[5] += o[7] * dt;
	}

	this.t0 = t;
}

Simulation.prototype.onKeyDown = function( code ) {
	console.log( 'down ' + code );

	if( code === 38 ) { // up
		var a = this.objects[0][2];

		this.objects[0][5].set( 0, Math.cos( a ), Math.sin( a ) );
	}
	else if( code === 39 ) { // right

	}
	else if( code === 0 ) { // left

	}
	else if( code === 39 ) { // down

	}
}

Simulation.prototype.onKeyUp = function( code ) {
	console.log( 'up   ' + code );

	this.objects[0][6] -= Math.cos( this.objects[0][2] );	
	this.objects[0][7] -= Math.sin( this.objects[0][2] );	
}

Simulation.prototype.init = function( t ) {
	this.t0 = t;
}


Simulation.prototype.update = function( t ) {
	while( this.events.length > 0 ) {
		var event = this.events.shift();

		this.pass( event.timeStamp );

		if( event.type === 'keydown' ) {
			if( ! this.keys[ event.keyCode ] ) {
				this.keys[ event.keyCode ] = true;

				this.onKeyDown( event.keyCode );
			}
		}
		else if( event.type === 'keyup' ) {
			delete this.keys[ event.keyCode ];

			this.onKeyUp( event.keyCode );
		}
	}

	this.pass( t );
}

Simulation.prototype.paint = function( context ) {
	context.clearRect( 0, 0, 360, 360 );

	context.beginPath();

	for( var i = 0; i < this.objects.length; ++i ) {
		var o = this.objects[i];

		var x = ( o[0] + 0.5 ) | 0, y = ( o[1] + 0.5 ) | 0, a = ( ( ( o[2] * 16 / Math.PI + 0.5 ) | 0 ) % 32 ) * Math.PI / 16;

		context.translate( x, y );
		context.rotate( a );

		context.moveTo( 12, 0 );
		context.lineTo( -8, -8 );
		context.lineTo( -8, 8 );
		context.lineTo( 12, 0 );

		context.rotate( -a );
		context.translate( -x, -y );

		x = o[0];
		y = o[1];
		a = o[2];

		context.translate( x, y );
		context.rotate( a );

		context.moveTo( 12, 0 );
		context.lineTo( -8, -8 );
		context.lineTo( -8, 8 );
		context.lineTo( 12, 0 );

		context.rotate( -a );
		context.translate( -x, -y );
	}

	context.stroke();
}

function init( t ) {
	simulation = new Simulation();

	window.onkeydown = simulation.pushEvent;
	window.onkeyup = simulation.pushEvent;

	simulation.add( 180, 180, 0, 0, 0, 0, 0, 0, 0 );

	simulation.init( t );
	simulation.paint( context );

	webkitRequestAnimationFrame( update, canvas );
}

function update( t ) {
	simulation.update( t );
	simulation.paint( context );

	webkitRequestAnimationFrame( update, canvas );
}

window.onload = function( event ) {
	canvas = $('canvas');
	context = canvas.getContext('2d');

	init( Date.now() );
}
</script>
</head>

<body>
	<canvas id="canvas" width="360" height="360"/>
</body>

</html>
